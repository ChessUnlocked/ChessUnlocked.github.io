<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChessUnlocked - Level Up Your Chess Openings</title>
    <meta name="description" content="Master chess openings with ChessUnlocked. Learn the London System, Slav Defense, King's Indian, and more with spaced repetition, rich stats, and community wisdom.">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- PGN Parser Library -->
    <script src="https://cdn.jsdelivr.net/npm/pgn-parser@1.1.0/pgn-parser.js"></script>

</head>
<body class="bg-indigo-50 dark:bg-gray-900 transition-colors duration-500">
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-indigo-600 text-white px-4 py-2 rounded">Skip to main content</a>
    <div id="statusRibbon" class="fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg text-white text-sm bg-gray-900 hidden" style="z-index:9999;"></div>

    <!-- Header -->
    <header class="bg-gradient-header text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 id="site-title" class="font-extrabold text-2xl tracking-tight select-none cursor-pointer">
                ChessUnlocked
            </h1>
            <div class="flex items-center">
                 <nav id="main-nav" class="space-x-4 text-lg font-semibold hidden md:flex items-center" role="navigation" aria-label="Main navigation">
                    <button id="nav-repertoire-btn" class="hover:text-yellow-300 transition-colors duration-200 focus:outline-none">Repertoire Hub</button>
                    <button id="nav-explorer-btn" class="hover:text-yellow-300 transition-colors duration-200 focus:outline-none">Explorer</button>
                    <button id="nav-practice-btn" class="hover:text-yellow-300 transition-colors duration-200 focus:outline-none">Practice</button>
                    <button id="nav-signin-btn" class="ml-4 px-4 py-2 bg-indigo-600 text-white rounded-md font-bold text-lg hover:bg-indigo-500 transition focus:outline-none">Sign In</button>
                    <button id="nav-signup-btn" class="ml-4 px-4 py-2 bg-yellow-400 text-indigo-900 rounded-md font-bold text-lg hover:bg-yellow-300 transition focus:outline-none">Sign Up</button>
                    <button id="nav-signout-btn" class="hidden ml-4 px-4 py-2 bg-pink-600 text-white rounded-md font-bold text-lg hover:bg-pink-500 transition focus:outline-none">Sign Out</button>
                </nav>

                <!-- Dark Mode Toggle -->
                <button id="darkModeToggler" aria-label="Toggle Dark Mode" class="ml-4 text-yellow-300 hover:text-yellow-400 focus:outline-none text-2xl">
                    üåô
                </button>
            </div>
        </div>
    </header>

    <main id="main">
        <!-- Hero -->
        <section class="bg-gradient-hero text-white py-24 px-6 text-center">
            <h2 class="text-5xl font-extrabold mb-4 max-w-3xl mx-auto leading-tight">
                Level Up Your Chess Openings with <span class="text-yellow-400">ChessUnlocked</span>
            </h2>
            <p class="text-xl max-w-2xl mx-auto mb-8">
                Master the London System, Slav Defense, King's Indian, and more with spaced repetition, rich stats, master games, and community wisdom.
            </p>
            <a id="hero-get-started" class="inline-block bg-yellow-400 text-indigo-900 font-bold px-8 py-4 rounded-lg shadow-lg hover:bg-yellow-300 transition">
                Get Started for Free
            </a>
        </section>

        <!-- Features -->
        <section class="container mx-auto px-6 py-20">
            <h2 class="text-4xl font-extrabold text-center mb-12 text-gray-800 dark:text-white">
                Everything You Need to Succeed
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <article id="repertoire" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-5xl mb-4">‚ôüÔ∏è</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">Repertoire Hub</h3>
                    <p class="text-gray-700 dark:text-gray-300">Explore the full ECO-indexed opening list with powerful search and filtering.</p>
                 </article>

                <article id="explorer" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-5xl mb-4">üó∫Ô∏è</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">Explorer Board</h3>
                    <p class="text-gray-700 dark:text-gray-300">Watch famous openings unfold and explore key variations.</p>
                 </article>

                <article id="practice" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-5xl mb-4">üéØ</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">Practice Modes</h3>
                    <p class="text-gray-700 dark:text-gray-300">Master openings through Learn, Drill, Time Trials, and Puzzle Galleries.</p>
                 </article>

                <!-- Recommendations: requires full sign-in to call the coach -->
                 <article id="recommendations" data-requires-auth="true" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300 locked" role="button" tabindex="0" aria-pressed="false">
                    <div class="text-5xl mb-4">üí°</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">‚ú® Recommendations</h3>
                    <p class="text-gray-700 dark:text-gray-300">Get expert suggestions to expand and refine your repertoire.</p>
                 </article>

                <!-- Customization: gated -->
                 <article id="customization" data-requires-auth="true" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300 locked" role="button" tabindex="0">
                    <div class="text-5xl mb-4">üé®</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">Customization</h3>
                    <p class="text-gray-700 dark:text-gray-300">Themes, dark mode, and board styles tailored to your preferences.</p>
                 </article>

                <!-- Analysis: gated -->
                 <article id="analysis" data-requires-auth="true" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300 locked" role="button" tabindex="0">
                    <div class="text-5xl mb-4">üìà</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">Game Analysis</h3>
                    <p class="text-gray-700 dark:text-gray-300">Upload your games to receive opening insights and coaching hints.</p>
                 </article>

                <!-- Stats: gated -->
                 <article id="stats" data-requires-auth="true" class="feature-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 text-center flex flex-col items-center hover:shadow-2xl transition-shadow duration-300 locked" role="button" tabindex="0">
                    <div class="text-5xl mb-4">üìä</div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-yellow-400">Performance Stats</h3>
                    <p class="text-gray-700 dark:text-gray-300">Track your progress and identify areas for improvement.</p>
                 </article>
            </div>
        </section>

        <!-- Placeholder Sections -->
        <section id="repertoire-hub-section" class="container mx-auto px-6 py-12 bg-gray-200 dark:bg-gray-800 rounded-lg my-8 hidden">
            <h2 class="text-3xl font-extrabold mb-8 text-gray-800 dark:text-yellow-400 text-center">Repertoire Hub</h2>
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <input type="search" id="repertoireSearch" placeholder="Search openings by name or ECO code..." class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div id="repertoireList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Openings will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <section id="explorer-section" class="container mx-auto px-6 py-12 hidden">
            <h2 class="text-3xl font-extrabold mb-8 text-gray-800 dark:text-yellow-400 text-center">
                Interactive Explorer Board
            </h2>
            <div class="flex justify-center">
                 <div id="chessboard" class="chessboard" aria-hidden="false"></div>
            </div>
            <div class="mt-6 text-center max-w-lg mx-auto">
                <p id="opening-info" class="text-gray-800 dark:text-gray-300 mb-4">
                    Watch a demonstration of a popular opening! Click the button to see the moves.
                </p>
                <div class="flex items-center justify-center space-x-4">
                    <button id="prevMoveBtn" class="bg-gray-600 text-white font-bold px-4 py-2 rounded-lg shadow-md hover:bg-gray-500 transition" disabled>< Prev</button>
                    <button id="animate-opening-btn" class="bg-indigo-600 text-white font-bold px-6 py-2 rounded-lg shadow-md hover:bg-indigo-500 transition">
                        Play Ruy Lopez Opening
                    </button>
                    <button id="nextMoveBtn" class="bg-gray-600 text-white font-bold px-4 py-2 rounded-lg shadow-md hover:bg-gray-500 transition" disabled>Next ></button>
                </div>
            </div>
        </section>

        <section id="practice-section" class="container mx-auto px-6 py-12 bg-gray-200 dark:bg-gray-800 rounded-lg my-8 hidden">
            <h2 class="text-3xl font-extrabold mb-8 text-gray-800 dark:text-yellow-400 text-center">Practice Modes</h2>
            <div id="practiceDrill" class="max-w-2xl mx-auto bg-white dark:bg-gray-700 p-6 rounded-lg shadow">
                <!-- Practice drill content will be inserted here -->
            </div>
        </section>

        <!-- Signup Section -->
        <section id="signup-section" class="bg-gradient-signup py-16 px-6 text-indigo-900">
            <div class="container mx-auto max-w-lg text-center">
                 <div id="signupCard" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-10">
                    <div id="firebase-error" class="hidden text-red-500 font-bold mb-4"></div>
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 text-yellow-400 py-6 text-center select-none">
        <p>¬© 2025 ChessUnlocked ‚Äî Crafted with ‚ôüÔ∏è by passionate chess learners.</p>
    </footer>

    <!-- Generic Modal -->
    <div id="featureModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" aria-hidden="true">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 max-w-md w-full">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-900 dark:text-yellow-400"></h3>
            <p id="modalDescription" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <button id="modalCloseBtn" class="w-full bg-indigo-800 text-yellow-400 font-bold py-2 rounded-md hover:bg-indigo-700 transition focus:outline-none">
                Got it!
            </button>
        </div>
    </div>

    <!-- Recommendation Modal -->
    <div id="recommendationModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300" aria-hidden="true">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8 max-w-lg w-full transform transition-all duration-300 scale-95">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-yellow-400">‚ú® Opening Recommendations</h3>
                <button id="recommendationCloseBtn" class="text-2xl font-bold text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white leading-none" aria-label="Close">&times;</button>
            </div>
            <div id="recommendationContent">
                <p class="text-gray-700 dark:text-gray-300 mb-6">Tell us your style, and our coach will suggest new openings to explore!</p>
                <div id="recommendationForm">
                    <div class="space-y-4">
                        <div>
                            <label for="playingStyle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Playing Style:</label>
                            <select id="playingStyle" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option>Aggressive</option>
                                <option>Positional</option>
                                <option>Solid & Defensive</option>
                                <option>Tricky & Tactical</option>
                            </select>
                        </div>
                        <div>
                            <label for="favoriteOpening" class="block text-sm font-medium text-gray-700 dark:text-gray-300">A Favorite Opening You Play:</label>
                            <input type="text" id="favoriteOpening" placeholder="e.g., Sicilian Defense" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <button id="getRecommendationBtn" class="mt-6 w-full bg-indigo-800 text-yellow-400 font-bold py-3 rounded-md hover:bg-indigo-700 transition focus:outline-none flex items-center justify-center">
                        Get Recommendations ‚ú®
                    </button>
                </div>

                <div id="recommendationResult" class="mt-4 hidden prose prose-sm dark:prose-invert max-w-none prose-h4:text-yellow-500 prose-h4:dark:text-yellow-400 prose-code:bg-gray-200 prose-code:dark:bg-gray-700 prose-code:p-1 prose-code:rounded"></div>
                <div id="recommendationLoader" class="mt-6 hidden text-center">
                     <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400 mx-auto"></div>
                     <p class="mt-2 text-gray-600 dark:text-gray-400">Our coach is thinking...</p>
                </div>
             </div>
        </div>
    </div>


    <!-- Firebase + App JS -->
    <script type="module">
        /***** üîß CONFIG ‚Äî REPLACE THESE VALUES (Firebase + Gemini) *****/
        const CONFIG = {
            APP_ID: "chessunlocked-prod", // any string; used only in Firestore path
            FIREBASE: {
                apiKey: "AIzaSyAEtdyYgFABdmWxBVQUmWXKNKE8Ae5dAKI",
                authDomain: "chessunlocked-3ffe1.firebaseapp.com",
                projectId: "chessunlocked-3ffe1",
                storageBucket: "chessunlocked-3ffe1.firebasestorage.app",
                messagingSenderId: "530515763757",
                appId: "1:530515763757:web:d0328b88329ca4009a4ea4"
            },
            GEMINI_API_KEY: "AIzaSyAfVgcEB0PxaOt34lZqiohqqqgKn9xpzfU"
        };
        /***** END CONFIG *****/

        // --- Helper: show a bottom-right ribbon with status info
        function setRibbon(text, color = 'bg-gray-900') {
            const el = document.getElementById('statusRibbon');
            if (!el) return;
            el.textContent = text;
            el.classList.remove('hidden', 'bg-red-700', 'bg-emerald-700', 'bg-yellow-700', 'bg-gray-900');
            el.classList.add(color);
        }

        // --- Diagnostic: Check Gemini API key and endpoint on page load
        async function checkGeminiAPI() {
            const testPrompt = {
                contents: [{ role: 'user', parts: [{ text: 'Test connection.' }] }]
            };
            const testUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${encodeURIComponent(CONFIG.GEMINI_API_KEY)}`;
            try {
                const resp = await fetch(testUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPrompt)
                });
                if (!resp.ok) {
                    console.error(`Gemini API error: ${resp.status} ${resp.statusText}`);
                    return;
                }
                console.log('Gemini API connection OK');
            } catch (err) {
                console.error('Gemini API unreachable. Check your network or API key.');
            }
        }

        window.addEventListener('DOMContentLoaded', checkGeminiAPI);

        // --- Sanity checks so ‚ÄúSignup Error‚Äù is actually actionable
        function validateConfig() {
            const f = CONFIG.FIREBASE || {};
            const missing = [];
            ['apiKey','authDomain','projectId','appId'].forEach(k => { if (!f[k]) missing.push(`FIREBASE.${k}`); });
            if (!CONFIG.GEMINI_API_KEY) missing.push('GEMINI_API_KEY');
            return missing;
        }

        // Pieces map (kept from your original)
        const pieces = {'r':'‚ôú','n':'‚ôû','b':'‚ôù','q':'‚ôõ','k':'‚ôö','p':'‚ôüÔ∏é','R':'‚ôñ','N':'‚ôò','B':'‚ôó','Q':'‚ôï','K':'‚ôî','P':'‚ôô'};

        // DOM refs (grab early)
        const navSigninBtn = document.getElementById('nav-signin-btn');
        const navSignupBtn = document.getElementById('nav-signup-btn');
        const navSignoutBtn = document.getElementById('nav-signout-btn');
        const signupCard = document.getElementById('signupCard');
        const darkModeToggler = document.getElementById('darkModeToggler');
        const html = document.documentElement;
        const featureModal = document.getElementById('featureModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalDescription = document.getElementById('modalDescription');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        const recommendationModal = document.getElementById('recommendationModal');
        const recommendationCloseBtn = document.getElementById('recommendationCloseBtn');
        const recommendationForm = document.getElementById('recommendationForm');
        const recommendationLoader = document.getElementById('recommendationLoader');
        const recommendationResult = document.getElementById('recommendationResult');
        const getRecommendationBtn = document.getElementById('getRecommendationBtn');

        // Explorer refs
        let boardElement = document.getElementById('chessboard');
        const openingInfo = document.getElementById('opening-info');
        const animateBtn = document.getElementById('animate-opening-btn');

        // --- Premium Content ---
        const premiumSections = ['repertoire-hub-section', 'explorer-section', 'practice-section'];

        // --- Utility: Generic modal open/close ---
        function openModal(title, description) {
            modalTitle.textContent = title;
            modalDescription.textContent = description;
            featureModal.classList.remove('hidden');
            featureModal.setAttribute('aria-hidden', 'false');
        }
        function closeModal() {
            featureModal.classList.add('hidden');
            featureModal.setAttribute('aria-hidden', 'true');
        }
        modalCloseBtn?.addEventListener('click', closeModal);
        featureModal?.addEventListener('click', (e) => { if (e.target === featureModal) closeModal(); });

        // Recommendation modal helpers
        function openRecommendationModal() {
            recommendationModal?.classList.remove('hidden');
            recommendationModal?.setAttribute('aria-hidden', 'false');
        }
        function closeRecommendationModal() {
            recommendationModal?.classList.add('hidden');
            recommendationModal?.setAttribute('aria-hidden', 'true');
        }
        recommendationCloseBtn?.addEventListener('click', closeRecommendationModal);
        recommendationModal?.addEventListener('click', (e) => { if (e.target === recommendationModal) closeRecommendationModal(); });

        // --- Theme (dark mode) logic ---
        function applyTheme(isDark) {
            if (isDark) { html.classList.add('dark'); darkModeToggler.textContent = '‚òÄÔ∏è'; }
            else { html.classList.remove('dark'); darkModeToggler.textContent = 'üåô'; }
        }
        (function initTheme() {
            try {
                const stored = localStorage.getItem('theme');
                if (stored === 'dark') applyTheme(true);
                else if (stored === 'light') applyTheme(false);
                else {
                    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    applyTheme(prefersDark);
                    localStorage.setItem('theme', prefersDark ? 'dark' : 'light');
                }
            } catch { applyTheme(false); }
        })();
        darkModeToggler?.addEventListener('click', () => {
            const newIsDark = !html.classList.contains('dark');
            try { localStorage.setItem('theme', newIsDark ? 'dark' : 'light'); } catch {}
            applyTheme(newIsDark);
        });

        // --- Chessboard rendering and animation (Ruy Lopez demo) ---
        const ruyLopezSequence = [
            { pos: ['rnbqkbnr','pppppppp','........','........','........','........','PPPPPPPP','RNBQKBNR'], move: 'Starting Position' },
            { pos: ['rnbqkbnr','pppppppp','........','........','....P...','........','PPPP.PPP','RNBQKBNR'], move: '1. e4' },
            { pos: ['rnbqkbnr','pppp.ppp','........','....p...','....P...','........','PPPP.PPP','RNBQKBNR'], move: '1... e5' },
            { pos: ['rnbqkbnr','pppp.ppp','........','....p...','....P...','.....N..','PPPP.PPP','RNBQKB.R'], move: '2. Nf3' },
            { pos: ['r.bqkbnr','pppp.ppp','..n.....','....p...','....P...','.....N..','PPPP.PPP','RNBQKB.R'], move: '2... Nc6' },
            { pos: ['r.bqkbnr','pppp.ppp','..n.....','.B..p...','....P...','.....N..','PPPP.PPP','RNBQK..R'], move: '3. Bb5' },
        ];
        let animationInterval = null;
        function renderBoard(position, targetElement) {
            const board = targetElement || boardElement;
            if (!board) return;
            console.log(`Rendering board on element:`, board.id);
            board.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                const rowStr = position[row];
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    const isDark = (row + col) % 2 !== 0;
                    square.className = `chessboard-square ${isDark ? 'dark-square' : 'light-square'}`;
                    const pieceChar = rowStr[col];
                    if (pieceChar && pieceChar !== '.') {
                        const pieceElement = document.createElement('span');
                        pieceElement.className = 'piece';
                        pieceElement.textContent = pieces[pieceChar] || '';
                        const isBlack = (pieceChar === pieceChar.toLowerCase());
                        pieceElement.style.color = isBlack ? '#1e293b' : '#f8fafc';
                        square.appendChild(pieceElement);
                    }
                    board.appendChild(square);
                }
            }
        }
        // initial render
        renderBoard(ruyLopezSequence[0].pos);
        animateBtn?.addEventListener('click', () => {
            clearInterval(animationInterval);
            let moveIndex = 0;
            animateBtn.disabled = true;
            animationInterval = setInterval(() => {
                if (moveIndex >= ruyLopezSequence.length) {
                    clearInterval(animationInterval);
                    openingInfo.textContent = "That's the Ruy Lopez! Click again to replay.";
                    animateBtn.disabled = false;
                    return;
                }
                const currentMove = ruyLopezSequence[moveIndex];
                openingInfo.textContent = currentMove.move;
                renderBoard(currentMove.pos);
                moveIndex++;
            }, 1200);
        });

        // --- App UI helpers (lock/unlock gated features) ---
        function setLockedState(locked) {
            document.querySelectorAll('[data-requires-auth]').forEach(el => {
                if (locked) { el.classList.add('locked'); el.setAttribute('aria-hidden', 'true'); }
                else { el.classList.remove('locked'); el.removeAttribute('aria-hidden'); }
            });
        }

        // Signup handler (with better error reporting)
        const handleSignup = async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const formMessage = document.getElementById('formMessage');
            const signupButton = document.getElementById('signupButton');
            const signupButtonText = document.getElementById('signup-button-text');
            const signupLoader = document.getElementById('signup-loader');

            const email = emailInput?.value?.trim() || '';
            const password = passwordInput?.value || '';

            if (password.length < 6) {
                formMessage.textContent = 'Password must be at least 6 characters.';
                formMessage.className = 'mt-2 font-semibold text-red-600';
                return;
            }
            signupButtonText?.classList.add('hidden');
            signupLoader?.classList.remove('hidden');
            if (signupButton) signupButton.disabled = true;
            if (formMessage) formMessage.textContent = '';

            try {
                if (!auth) throw new Error('Auth not initialized ‚Äî check Firebase config.');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                if (db) {
                    try {
                        const userDocRef = doc(db, `artifacts/${CONFIG.APP_ID}/users/${user.uid}/profile`, 'data');
                        await setDoc(userDocRef, { email: user.email, createdAt: new Date().toISOString() });
                    } catch (fsErr) {
                        console.warn("Firestore write failed:", fsErr);
                    }
                }
            } catch (error) {
                console.error("Signup Error:", error);
                const formMessageEl = document.getElementById('formMessage');
                const code = (error && error.code) ? String(error.code) : '';
                if (code === 'auth/invalid-email') formMessageEl.textContent = 'Please enter a valid email address.';
                else if (code === 'auth/operation-not-allowed') formMessageEl.textContent = 'Email/password sign-in is disabled in Firebase (enable it in Authentication ‚Üí Sign-in method).';
                else if (code === 'auth/email-already-in-use') formMessageEl.textContent = 'This email is already registered.';
                else if (String(error?.message || '').includes('Auth not initialized')) formMessageEl.textContent = 'Firebase is not initialized ‚Äî check the config at the top of index.html.';
                else formMessageEl.textContent = 'An error occurred. Open the browser console for details.';
                formMessageEl.className = 'mt-2 font-semibold text-red-600';
            } finally {
                signupButtonText?.classList.remove('hidden');
                signupLoader?.classList.add('hidden');
                if (signupButton) signupButton.disabled = false;
            }
        };

        // Show sign-up form
        const showSignupForm = () => {
            if (!signupCard) return;
            signupCard.innerHTML = `
                <h2 class="text-3xl font-extrabold mb-6 text-gray-900 dark:text-white">Join ChessUnlocked Today</h2>
                <p class="mb-6 text-gray-700 dark:text-gray-300">
                    Sign up for free to start mastering openings with personalized drills, master games, and community insights.
                </p>
                <form id="signupForm" class="flex flex-col space-y-4" novalidate>
                    <input type="email" id="emailInput" placeholder="Your email address" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400" required aria-label="Email address">
                    <input type="password" id="passwordInput" placeholder="Choose a password" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400" required aria-label="Password">
                    <button type="submit" id="signupButton" class="bg-indigo-800 text-yellow-400 font-bold py-3 rounded-md hover:bg-indigo-700 transition focus:outline-none flex justify-center items-center">
                        <span id="signup-button-text">Create Account</span>
                        <div id="signup-loader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-yellow-400 ml-3"></div>
                    </button>
                    <p id="formMessage" class="mt-2 font-semibold h-5" role="alert"></p>
                </form>
                <div class="text-center mt-4">
                    <p class="text-gray-600 dark:text-gray-400">Already have an account? 
                        <button id="switchToSignin" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 underline font-medium">Sign In</button>
                    </p>
                </div>
            `;
            document.getElementById('signupForm')?.addEventListener('submit', handleSignup);
            document.getElementById('switchToSignin')?.addEventListener('click', showSigninForm);
        };

        // Show sign-in form
        const showSigninForm = () => {
            if (!signupCard) return;
            signupCard.innerHTML = `
                <h2 class="text-3xl font-extrabold mb-6 text-gray-900 dark:text-white">Welcome Back!</h2>
                <p class="mb-6 text-gray-700 dark:text-gray-300">
                    Sign in to continue mastering your chess openings.
                </p>
                <form id="signinForm" class="flex flex-col space-y-4" novalidate>
                    <input type="email" id="signinEmailInput" placeholder="Email address" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-indigo-400" required aria-label="Email address">
                    <input type="password" id="signinPasswordInput" placeholder="Password" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-indigo-400" required aria-label="Password">
                    <button type="submit" id="signinButton" class="bg-indigo-600 text-white font-bold py-3 rounded-md hover:bg-indigo-500 transition focus:outline-none flex justify-center items-center">
                        <span id="signin-button-text">Sign In</span>
                        <div id="signin-loader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-3"></div>
                    </button>
                    <div class="text-center mt-3">
                        <button type="button" id="forgotPasswordLink" class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 underline focus:outline-none">
                            Forgot your password?
                        </button>
                    </div>
                    <p id="signinFormMessage" class="mt-2 font-semibold h-5" role="alert"></p>
                </form>
                <div class="text-center mt-4">
                    <p class="text-gray-600 dark:text-gray-400">Don't have an account? 
                        <button id="switchToSignup" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 underline font-medium">Sign Up</button>
                    </p>
                </div>
            `;
            document.getElementById('signinForm')?.addEventListener('submit', handleSignin);
            document.getElementById('forgotPasswordLink')?.addEventListener('click', handleForgotPassword);
            document.getElementById('switchToSignup')?.addEventListener('click', showSignupForm);
        };

        const showSignedOutUI = () => {
            navSigninBtn?.classList.remove('hidden');
            navSignupBtn?.classList.remove('hidden');
            navSignoutBtn?.classList.add('hidden');
            
            // Hide premium sections
            console.log('Hiding premium sections for signed-out user.');
            premiumSections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.classList.add('hidden');
                }
            });

            // Show the signup section
            const signupSection = document.getElementById('signup-section');
            if (signupSection) signupSection.classList.remove('hidden');

            // Default to showing signup form
            showSignupForm();
            setLockedState(true);

            // Show the "Get Started" button
            const heroGetStartedBtn = document.getElementById('hero-get-started');
            if (heroGetStartedBtn) {
                heroGetStartedBtn.classList.remove('hidden');
            }
        };

        const showSignedInUI = (user) => {
            const isFullUser = user && !user.isAnonymous;
            if (isFullUser) {
                navSigninBtn?.classList.add('hidden');
                navSignupBtn?.classList.add('hidden');
                navSignoutBtn?.classList.remove('hidden');
                
                // Hide the entire signup section and show user content
                const signupSection = document.getElementById('signup-section');
                if (signupSection) signupSection.classList.add('hidden');

                // This is a placeholder for where user-specific content would go.
                // For now, we'll just show a welcome message in the main part of the page.
                // A real app would have a #user-content section to show here.
                const emailText = user?.email || 'User';
                const welcomeMessage = `Welcome back, ${emailText}! You can now access all features.`;
                // For demonstration, let's reuse the repertoire hub to show the message.
                const repertoireHub = document.getElementById('repertoire-hub-section');
                if(repertoireHub) {
                    const welcomeP = repertoireHub.querySelector('p');
                    if (welcomeP) {
                        welcomeP.textContent = welcomeMessage;
                    } else {
                        // Create a welcome paragraph if it doesn't exist
                        const welcomeParagraph = document.createElement('p');
                        welcomeParagraph.textContent = welcomeMessage;
                        welcomeParagraph.className = 'text-center text-gray-800 dark:text-gray-300 mb-4';
                        repertoireHub.insertBefore(welcomeParagraph, repertoireHub.firstChild.nextSibling);
                    }
                }

               // Show premium sections
                console.log('Showing premium sections for signed-in user.');
                premiumSections.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) {
                        section.classList.remove('hidden');
                    }
                });

             } else {
                 navSigninBtn?.classList.remove('hidden');
                 navSignupBtn?.classList.remove('hidden');
                navSignoutBtn?.classList.add('hidden');
                
                const signupSection = document.getElementById('signup-section');
                if (signupSection) signupSection.classList.remove('hidden');
                
                // Explicitly hide premium sections for anonymous users
                premiumSections.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) {
                        section.classList.add('hidden');
                    }
                });

                showSignupForm();
            }
            setLockedState(!isFullUser);

            // Hide the "Get Started" button if the user is fully signed in
            const heroGetStartedBtn = document.getElementById('hero-get-started');
            if (heroGetStartedBtn) {
                if (isFullUser) {
                    heroGetStartedBtn.classList.add('hidden');
                } else {
                    heroGetStartedBtn.classList.remove('hidden');
                }
            }
        };

        // Sign in handler
        const handleSignin = async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById('signinEmailInput');
            const passwordInput = document.getElementById('signinPasswordInput');
            const formMessage = document.getElementById('signinFormMessage');
            const signinButton = document.getElementById('signinButton');
            const signinButtonText = document.getElementById('signin-button-text');
            const signinLoader = document.getElementById('signin-loader');

            const email = emailInput?.value?.trim() || '';
            const password = passwordInput?.value || '';

            if (!email || !password) {
                formMessage.textContent = 'Please enter your email and password.';
                formMessage.className = 'mt-2 font-semibold text-red-600';
                return;
            }
            signinButtonText?.classList.add('hidden');
            signinLoader?.classList.remove('hidden');
            if (signinButton) signinButton.disabled = true;
            if (formMessage) formMessage.textContent = '';

            try {
                if (!auth) throw new Error('Auth not initialized ‚Äî check Firebase config.');
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // Success: UI will update via onAuthStateChanged
            } catch (error) {
                const code = (error && error.code) ? String(error.code) : '';
                if (code === 'auth/invalid-email') formMessage.textContent = 'Invalid email address.';
                else if (code === 'auth/user-not-found') formMessage.textContent = 'No account found for this email.';
                else if (code === 'auth/wrong-password') formMessage.textContent = 'Incorrect password.';
                else if (String(error?.message || '').includes('Auth not initialized')) formMessage.textContent = 'Firebase is not initialized ‚Äî check the config at the top of index.html.';
                else formMessage.textContent = 'Your email or password is incorrect';

                
                formMessage.className = 'mt-2 font-semibold text-red-600';
            } finally {
                signinButtonText?.classList.remove('hidden');
                signinLoader?.classList.add('hidden');
                if (signinButton) signinButton.disabled = false;
            }
        };

        // Forgot password handler
        const handleForgotPassword = async () => {
            console.log('Forgot password clicked');
            const emailInput = document.getElementById('signinEmailInput');
            const email = emailInput?.value?.trim() || '';
            
            console.log('Email entered:', email);
            
            if (!email) {
                alert('Please enter your email address first.');
                emailInput?.focus();
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            console.log('Auth object:', auth);
            console.log('sendPasswordResetEmail function:', sendPasswordResetEmail);
            
            try {
                if (!auth) {
                    console.error('Auth not initialized');
                    throw new Error('Auth not initialized');
                }
                
                console.log('Sending password reset email to:', email);
                
                // Add action code settings for better email handling
                const actionCodeSettings = {
                    url: window.location.origin, // Use current domain as the continue URL
                    handleCodeInApp: false
                };
                
                await sendPasswordResetEmail(auth, email, actionCodeSettings);
                console.log('Password reset email sent successfully');
                alert('Password reset email sent! Check your inbox (and spam folder) for instructions to reset your password.');
            } catch (error) {
                console.error('Password reset error:', error);
                console.error('Error code:', error?.code);
                console.error('Error message:', error?.message);
                
                const code = error?.code || '';
                if (code === 'auth/user-not-found') {
                    // For security, we show a generic message but still log the actual error
                    console.log('User not found, showing generic message');
                    alert('If an account with this email exists, you will receive a password reset email shortly.');
                } else if (code === 'auth/invalid-email') {
                    alert('Please enter a valid email address.');
                } else if (code === 'auth/too-many-requests') {
                    alert('Too many password reset attempts. Please wait a few minutes before trying again.');
                } else if (code === 'auth/network-request-failed') {
                    alert('Network error. Please check your internet connection and try again.');
                } else {
                    alert(`Unable to send password reset email: ${error?.message || 'Unknown error'}. Please try again later.`);
                }
            }
        };

        // --- Import Firebase (from CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Auth init ---
        let app = null, auth = null, db = null;

        // Init guard + helpful status
        (function bootstrap() {
            const missing = validateConfig();
            if (missing.length) {
                setRibbon(`Missing config: ${missing.join(', ')}`, 'bg-yellow-700');
                console.warn('Missing required config keys:', missing);
            } else {
                setRibbon('Config OK. Initializing‚Ä¶', 'bg-emerald-700');
            }
        })();

        try {
            app = initializeApp(CONFIG.FIREBASE);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("‚úÖ Firebase initialized.");
            setRibbon('Firebase ready', 'bg-emerald-700');
        } catch (error) {
            console.error("‚ùå Firebase initialization failed:", error);
            setRibbon('Firebase init failed ‚Äî open console', 'bg-red-700');
            const firebaseErrorDiv = document.getElementById('firebase-error');
            if (firebaseErrorDiv) {
                firebaseErrorDiv.textContent = 'Error: Could not connect to services. Please check your Firebase project settings and ensure this domain is authorized.';
                firebaseErrorDiv.classList.remove('hidden');
            }
            if (signupCard) {
                signupCard.innerHTML = `<p class="text-red-500 font-bold">Error: Could not connect to services. Check your Firebase config at the top of index.html and refresh.</p>`;
            }
        }

        // --- Auth state observer ---
        if (auth) {
            onAuthStateChanged(auth, user => {
                try {
                    if (user) {
                        console.log("User is signed in:", user.uid, "isAnonymous:", !!user.isAnonymous);
                        showSignedInUI(user);
                        // Load user-specific theme after auth state is confirmed
                        loadUserBoardTheme(user);
                    } else {
                        console.log("User is signed out.");
                        showSignedOutUI();
                        // Clear user-specific data on sign out
                        try {
                            const keys = Object.keys(localStorage);
                            keys.forEach(key => {
                                if (key.startsWith('boardTheme_')) {
                                    localStorage.removeItem(key);
                                }
                            });
                        } catch (e) {
                            console.warn('Could not clear user-specific localStorage', e);
                        }
                    }
                } catch (error) {
                    console.error('Error in auth state change handler:', error);
                    // Fallback to signed out state if there's an error
                    showSignedOutUI();
                }
            });
        } else {
            showSignedOutUI();
        }

        // --- Initial Sign In (anonymous by default if no token) ---
        // Wait for auth to be fully initialized before attempting anonymous sign-in
        (async function initialSignIn() {
            if (!auth) return;
            
            // Add a small delay to ensure auth state observer is set up
            setTimeout(async () => {
                try {
                    // Only sign in anonymously if no user is already signed in
                    if (!auth.currentUser) {
                        console.log("No current user, signing in anonymously...");
                        await signInAnonymously(auth);
                    } else {
                        console.log("User already signed in:", auth.currentUser.uid);
                    }
                } catch (error) {
                    console.error("Initial sign-in error:", error);
                    // If anonymous sign-in fails, just show signed out UI
                    showSignedOutUI();
                }
            }, 100);
        })();

        // --- Sign Out ---
        navSignoutBtn?.addEventListener('click', async () => {
            if (!auth) return;
            try {
                // Clear user-specific data before signing out
                try {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('boardTheme_') || key.startsWith('performanceStats_')) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (e) {
                    console.warn('Could not clear user-specific localStorage', e);
                }
                
                // Sign out from Firebase
                await signOut(auth);
                
                // On sign out, revert to the default theme
                applyBoardTheme('classic');
                
                console.log('User signed out successfully');
            } catch (error) {
                console.error('Sign Out Error', error);
                openModal('Sign Out Failed', 'There was a problem signing you out. Please try again.');
            }
        });

        // --- Smooth Scrolling helpers ---
        const scrollToSection = (selector) => {
            const element = document.querySelector(selector);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        // Attach nav + header listeners
        document.getElementById('site-title')?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        document.getElementById('nav-repertoire-btn')?.addEventListener('click', () => scrollToSection('#repertoire-hub-section'));
        document.getElementById('nav-explorer-btn')?.addEventListener('click', () => scrollToSection('#explorer-section'));
        document.getElementById('nav-practice-btn')?.addEventListener('click', () => scrollToSection('#practice-section'));
        document.getElementById('hero-get-started')?.addEventListener('click', () => scrollToSection('#signup-section'));
        navSigninBtn?.addEventListener('click', () => {
            scrollToSection('#signup-section');
            setTimeout(showSigninForm, 100);
        });
        navSignupBtn?.addEventListener('click', () => {
            scrollToSection('#signup-section');
            setTimeout(showSignupForm, 100);
        });

        // --- Guard helpers for gated features ---
        function runIfFullUser(action) {
            const user = auth?.currentUser;
            // At the time of the click, check the user's state
            if (user && !user.isAnonymous) {
                action();
            } else {
                // If not a full user, show the sign-in prompt and stop.
                openModal('Feature Locked', 'This feature requires a full account. Please sign up or sign in to unlock it.');
                // Ensure no further execution happens.
                return;
            }
        }
        function guardedOpenModal(title, contentGenerator) {
            runIfFullUser(contentGenerator);
        }
        function guardedOpenRecommendationModal() { runIfFullUser(() => openRecommendationModal()); }

        // Attach clicks for gated items
        document.getElementById('recommendations')?.addEventListener('click', guardedOpenRecommendationModal);
        document.getElementById('customization')?.addEventListener('click', () =>
            guardedOpenModal('Customization', openCustomizationModal)
        );
        document.getElementById('analysis')?.addEventListener('click', () =>
            guardedOpenModal('Game Analysis', openGameAnalysisModal)
        );
        document.getElementById('stats')?.addEventListener('click', () =>
            guardedOpenModal('Performance Stats', openPerformanceStatsModal)
        );

        // Keyboard activation on feature cards
        document.querySelectorAll('[data-requires-auth]').forEach(el => {
            el.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); el.click(); }
            });
        });

        // --- Customization Modal Logic ---
        const boardThemes = {
            classic: { light: '#f0d9b5', dark: '#b58863', border: '#6b3d25' },
            marble: { light: '#e0e0e0', dark: '#a0a0a0', border: '#424242' },
            ocean: { light: '#cce7f5', dark: '#6b9ac4', border: '#3b5998' },
            forest: { light: '#d1e7dd', dark: '#8fbc8f', border: '#2e8b57' },
        };

        function applyBoardTheme(themeName) {
            const theme = boardThemes[themeName];
            if (!theme || !boardElement) return;

            boardElement.style.borderColor = theme.border;
            document.querySelectorAll('.light-square').forEach(sq => sq.style.backgroundColor = theme.light);
            document.querySelectorAll('.dark-square').forEach(sq => sq.style.backgroundColor = theme.dark);
            
            try {
                const user = auth?.currentUser;
                // If a user is signed in, save the theme to a user-specific key.
                if (user && !user.isAnonymous) {
                    localStorage.setItem(`boardTheme_${user.uid}`, themeName);
                } else {
                    // Fallback for anonymous or signed-out users (though it will be cleared on signout)
                    localStorage.setItem('boardTheme', themeName);
                }
            } catch (e) {
                console.warn('Could not save board theme to localStorage', e);
            }
        }

        function openCustomizationModal() {
            const currentTheme = localStorage.getItem('boardTheme') || 'classic';
            const optionsHtml = Object.keys(boardThemes).map(themeName =>
                `<option value="${themeName}" ${currentTheme === themeName ? 'selected' : ''}>
                    ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}
                </option>`
            ).join('');

            const customizationContent = `
                <div class="space-y-4">
                    <div>
                        <label for="boardThemeSelector" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Board Theme:</label>
                        <select id="boardThemeSelector" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            ${optionsHtml}
                        </select>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Your selection is saved automatically.</p>
                </div>
            `;
            modalTitle.textContent = 'üé® Customization';
            modalDescription.innerHTML = customizationContent;
            featureModal.classList.remove('hidden');
            featureModal.setAttribute('aria-hidden', 'false');

            // Add event listener after the modal is populated
            const themeSelector = document.getElementById('boardThemeSelector');
            themeSelector?.addEventListener('change', (e) => {
                applyBoardTheme(e.target.value);
            });
        }

        // Apply saved theme on initial load
        // This function will be called when the user's auth state is known.
        function loadUserBoardTheme(user) {
            let savedTheme = 'classic'; // Default theme
            try {
                if (user && !user.isAnonymous) {
                    // If a user is signed in, try to load their specific theme.
                    const userTheme = localStorage.getItem(`boardTheme_${user.uid}`);
                    if (userTheme && boardThemes[userTheme]) {
                        savedTheme = userTheme;
                    }
                }
                // No need for a fallback to the global theme, as it should be cleared on logout.
            } catch (e) {
                console.warn('Could not load board theme from localStorage', e);
            }
            applyBoardTheme(savedTheme);
        }

        // --- Performance Stats Modal Logic ---
        function getPerformanceStats() {
            // In a real app, this data would come from Firestore.
            // We'll use localStorage to simulate persistence.
            try {
                const stats = localStorage.getItem('performanceStats');
                if (stats) {
                    return JSON.parse(stats);
                }
            } catch (e) { console.warn('Could not parse performance stats', e); }
            
            // Default stats if none are saved
            return {
                'Ruy Lopez': 85,
                'Sicilian Defense': 60,
                "Queen's Gambit": 30,
            };
        }

        function savePerformanceStats(stats) {
            try {
                localStorage.setItem('performanceStats', JSON.stringify(stats));
            } catch (e) { console.warn('Could not save performance stats', e); }
        }

        function openPerformanceStatsModal() {
            const stats = getPerformanceStats();
            const statsHtml = Object.entries(stats).map(([opening, mastery]) => {
                const color = mastery > 80 ? 'bg-green-600' : mastery > 50 ? 'bg-yellow-400' : 'bg-red-600';
                return `
                    <div>
                        <strong>${opening}:</strong>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div class="${color} h-2.5 rounded-full" style="width: ${mastery}%"></div>
                        </div>
                        <p class="text-sm text-right">${mastery}% Mastery</p>
                    </div>
                `;
            }).join('');

            const statsContent = `
                <p>Here are your performance statistics:</p>
                <div class="mt-4 space-y-2">
                    ${statsHtml}
                </div>
                <button id="resetStatsBtn" class="mt-6 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">Reset Stats</button>
            `;
            modalTitle.textContent = 'üìä Performance Stats';
            modalDescription.innerHTML = statsContent;
            featureModal.classList.remove('hidden');
            featureModal.setAttribute('aria-hidden', 'false');

            const resetStatsBtn = document.getElementById('resetStatsBtn');
            if (resetStatsBtn) {
                resetStatsBtn.addEventListener('click', () => {
                    try {
                        // Reset to default stats
                        const defaultStats = {
                            'Ruy Lopez': 85,
                            'Sicilian Defense': 60,
                            "Queen's Gambit": 30,
                        };
                        savePerformanceStats(defaultStats);
                    } catch (e) {
                        console.warn('Could not reset performance stats', e);
                    }
                    closeModal();
                    openPerformanceStatsModal(); // Re-open to show the updated stats
                });
            }
        }

        // --- Game Analysis Modal Logic ---
        function handlePgnUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const pgnText = e.target.result;
                try {
                    const [parsed] = pgnParser.parse(pgnText);
                    if (!parsed) throw new Error('Invalid PGN data');
                    
                    const moves = parsed.moves.map(move => move.move).join(' ');
                    const analysisResult = `
                        <h4 class="font-bold text-lg">Game Found:</h4>
                        <p class="text-sm text-gray-500">${parsed.headers.White} vs ${parsed.headers.Black} (${parsed.headers.Date})</p>
                        <p class="mt-2 font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded text-sm">${moves}</p>
                        <p class="mt-4 text-green-600 dark:text-green-400"><strong>Analysis:</strong> This looks like a solid game! (Full analysis engine coming soon).</p>
                    `;
                    document.getElementById('analysisResult').innerHTML = analysisResult;

                } catch (err) {
                    document.getElementById('analysisResult').innerHTML = `<p class="text-red-500">Error parsing PGN: ${err.message}</p>`;
                }
            };
            reader.readAsText(file);
        }

        function openGameAnalysisModal() {
            const analysisContent = `
                <p>Upload a PGN file of your game to receive an analysis of your opening.</p>
                <div class="mt-4">
                    <label for="pgnUpload" class="block text-sm font-medium text-gray-700 dark:text-gray-300">PGN File:</label>
                    <input type="file" id="pgnUpload" accept=".pgn" class="mt-1 block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100
                    "/>
                </div>
                <div id="analysisResult" class="mt-4"></div>
            `;
            modalTitle.textContent = 'üìà Game Analysis';
            modalDescription.innerHTML = analysisContent;
            featureModal.classList.remove('hidden');
            featureModal.setAttribute('aria-hidden', 'false');

            document.getElementById('pgnUpload')?.addEventListener('change', handlePgnUpload);
        }

        // --- Recommendation button click (calls Gemini with browser fetch)
        getRecommendationBtn?.addEventListener('click', async () => {
            const user = auth?.currentUser;
            if (!user || user.isAnonymous) {
                openModal('Sign up to get recommendations', 'You must sign up for a full account to use the coach. Sign up or sign in to continue.');
                return;
            }

            const style = document.getElementById('playingStyle')?.value || 'Balanced';
            const opening = document.getElementById('favoriteOpening')?.value || 'the basics';
            const form = document.getElementById('recommendationForm');
            recommendationLoader?.classList.remove('hidden');
            if (form) form.classList.add('hidden');
            if (recommendationResult) { recommendationResult.innerHTML = ''; recommendationResult.classList.add('hidden'); }

            const prompt = `You are a friendly and encouraging chess coach. A student who enjoys a "${style}" playing style and currently plays "${opening}" wants to learn something new. Please recommend three new chess openings that would suit them. For each recommendation: 1. Give the name of the opening. 2. Provide a one-sentence, easy-to-understand description of its main idea. 3. List the first 3 typical moves for both White and Black. Format your response in simple HTML using <h4> for the opening name, <p> for the description, and <code> for the moves.`;

            try {
                if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                    throw new Error('Missing API key for recommendation service. Add GEMINI_API_KEY at the top of index.html.');
                }
                const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${encodeURIComponent(CONFIG.GEMINI_API_KEY)}`;

                let resp;
                try {
                    resp = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (networkErr) {
                    throw new Error('Network error: Unable to reach Gemini API. Check your internet connection or API URL.');
                }

                if (!resp.ok) throw new Error(`Coach API HTTP ${resp.status} - ${resp.statusText}`);
                let json;
                try {
                    json = await resp.json();
                } catch (jsonErr) {
                    throw new Error('Failed to parse response from Gemini API.');
                }
                const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error('Coach returned no content');

                recommendationResult.innerHTML = text;
                recommendationResult.classList.remove('hidden');

            } catch (err) {
                console.error('Recommendation Error:', err);
                recommendationResult.innerHTML = `<p class="text-red-500">Sorry ‚Äî the coach is unavailable right now. ${String(err?.message || '')}</p>`;
                recommendationResult.classList.remove('hidden');
            } finally {
                recommendationLoader?.classList.add('hidden');
                if (form) form.classList.remove('hidden');
            }
        });

        // --- ‚ÄúTest cases‚Äù for your page (quick validation in console) ---
        (function selfTests() {
            const cases = [];
            const f = CONFIG.FIREBASE || {};
            cases.push({ name: 'Firebase apiKey present', pass: !!f.apiKey });
            cases.push({ name: 'Auth domain present', pass: !!f.authDomain });
            cases.push({ name: 'Project ID present', pass: !!f.projectId });
            cases.push({ name: 'App ID present', pass: !!f.appId });
            cases.push({ name: 'Gemini key present', pass: !!CONFIG.GEMINI_API_KEY });

            const allPass = cases.every(c => c.pass);
            console.groupCollapsed('%cChessUnlocked ‚Äî setup self-tests', 'color:#10b981;font-weight:bold');
            cases.forEach(c => console.log(`${c.pass ? '‚úÖ' : '‚ùå'} ${c.name}`));
            console.log(allPass ? 'All checks passed.' : 'Some checks failed. See above.');
            console.groupEnd();
        })();

        // --- Repertoire Hub Logic ---
        const openingRepertoire = [
            { eco: 'A00', name: 'Anderssen\'s Opening', pgn: '1. a3' },
            { eco: 'A40', name: 'Queen\'s Pawn Game', pgn: '1. d4' },
            { eco: 'B00', name: 'King\'s Pawn Opening', pgn: '1. e4' },
            { eco: 'B01', name: 'Scandinavian Defense', pgn: '1. e4 d5' },
            { eco: 'B20', name: 'Sicilian Defense', pgn: '1. e4 c5' },
            { eco: 'C00', name: 'French Defense', pgn: '1. e4 e6' },
            { eco: 'C20', name: 'King\'s Pawn Game', pgn: '1. e4 e5' },
            { eco: 'C41', name: 'Philidor Defense', pgn: '1. e4 e5 2. Nf3 d6' },
            { eco: 'C50', name: 'Italian Game', pgn: '1. e4 e5 2. Nf3 Nc6 3. Bc4' },
            { eco: 'D00', name: 'Queen\'s Pawn Game', pgn: '1. d4 d5' },
            { eco: 'D06', name: 'Queen\'s Gambit', pgn: '1. d4 d5 2. c4' },
            { eco: 'E60', name: 'King\'s Indian Defense', pgn: '1. d4 Nf6 2. c4 g6' },
        ];

        function renderRepertoire(filter = '') {
            const listElement = document.getElementById('repertoireList');
            if (!listElement) return;

            const lowerFilter = filter.toLowerCase();
            const filteredOpenings = openingRepertoire.filter(op =>
                op.name.toLowerCase().includes(lowerFilter) ||
                op.eco.toLowerCase().includes(lowerFilter)
            );

            if (filteredOpenings.length === 0) {
                listElement.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">No openings found.</p>`;
                return;
            }

            listElement.innerHTML = filteredOpenings.map(op => `
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md transition-shadow cursor-pointer" data-pgn="${op.pgn}" data-name="${op.name}">
                    <h4 class="font-bold text-lg text-gray-900 dark:text-yellow-400">${op.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">${op.eco}</p>
                    <code class="text-sm text-gray-500 dark:text-gray-400 block mt-2">${op.pgn}</code>
                </div>
            `).join('');

            // Add click listeners to the new repertoire items
            listElement.querySelectorAll('[data-pgn]').forEach(el => {
                el.addEventListener('click', () => {
                    const pgn = el.dataset.pgn;
                    const name = el.dataset.name;
                    loadOpeningOnExplorer(name, pgn);
                    scrollToSection('explorer-section');
                });
            });
        }

        // Initial render and search listener
        (function initRepertoire() {
            renderRepertoire();
            const searchInput = document.getElementById('repertoireSearch');
            searchInput?.addEventListener('input', (e) => renderRepertoire(e.target.value));
        })();

        // --- Explorer Board Logic ---
        let currentOpening = { name: 'Ruy Lopez', pgn: '1. e4 e5 2. Nf3 Nc6 3. Bb5' };
        let currentMoveIndex = 0;
        let boardStates = []; // Will hold FEN-like board states for the current opening

        // This is a simplified PGN to board state converter. A real app would use a full chess library.
        function generateBoardStatesFromPgn(pgn) {
            // This is a mock function. A real implementation would require a full chess engine
            // to correctly generate board states (FENs) from PGN moves.
            // For now, we'll just use the hardcoded Ruy Lopez sequence if it matches.
            if (pgn.includes('Bb5')) {
                return ruyLopezSequence.map(s => s.pos);
            }
            // Return a simple sequence for other openings for demonstration
            return [
                ['rnbqkbnr','pppppppp','........','........','........','........','PPPPPPPP','RNBQKBNR'],
                ['rnbqkbnr','pppppppp','........','........','....P...','........','PPPP.PPP','RNBQKBNR'],
            ];
        }

        function updateExplorerUI() {
            renderBoard(boardStates[currentMoveIndex]);
            openingInfo.textContent = `${currentOpening.name} - Move ${currentMoveIndex}`;
            document.getElementById('prevMoveBtn').disabled = currentMoveIndex === 0;
            document.getElementById('nextMoveBtn').disabled = currentMoveIndex === boardStates.length - 1;
        }

        function loadOpeningOnExplorer(name, pgn) {
            currentOpening = { name, pgn };
            boardStates = generateBoardStatesFromPgn(pgn);
            currentMoveIndex = 0;
            updateExplorerUI();
        }

        document.getElementById('prevMoveBtn')?.addEventListener('click', () => {
            if (currentMoveIndex > 0) {
                currentMoveIndex--;
                updateExplorerUI();
            }
        });

        document.getElementById('nextMoveBtn')?.addEventListener('click', () => {
            if (currentMoveIndex < boardStates.length - 1) {
                currentMoveIndex++;
                updateExplorerUI();
            }
        });

        // Initial load
        loadOpeningOnExplorer(currentOpening.name, currentOpening.pgn);

        // --- Practice Mode Logic ---
        const practiceDrills = [
            {
                name: 'Name the Opening',
                board: ['r.bqkbnr','pppp.ppp','..n.....','.B..p...','....P...','.....N..','PPPP.PPP','RNBQK..R'], // Ruy Lopez
                question: 'Which opening is shown on the board?',
                options: ['Sicilian Defense', 'Ruy Lopez', 'Queen\'s Gambit'],
                answer: 'Ruy Lopez'
            },
            {
                name: 'Name the Opening',
                board: ['rnbqkbnr','pppp.ppp','........','....p...','....P...','........','PPPP.PPP','RNBQKBNR'], // King's Pawn
                question: 'Which opening is shown on the board?',
                options: ['King\'s Pawn Opening', 'French Defense', 'Italian Game'],
                answer: 'King\'s Pawn Opening'
            },
            {
                name: 'Name the Opening',
                board: ['rnbqkbnr','pp.ppppp','..n.....','..p.....','....P...','.....N..','PPPP.PPP','R.BQKB.R'], // Sicilian Defense
                question: 'Which opening is shown on the board?',
                options: ['French Defense', 'Caro-Kann Defense', 'Sicilian Defense'],
                answer: 'Sicilian Defense'
            },
            {
                name: 'Name the Opening',
                board: ['rnbqkbnr','pppp.ppp','.....p..','........','....P...','........','PPPP.PPP','RNBQKBNR'], // French Defense
                question: 'Which opening is shown on the board?',
                options: ['French Defense', 'Slav Defense', 'Dutch Defense'],
                answer: 'French Defense'
            },
            {
                name: 'Name the Opening',
                board: ['rnbqkbnr','ppp.pppp','..n.....','...p....','..P.P...','.....N..','PP.P.PPP','RNBQKB.R'], // Queen's Gambit
                question: 'Which opening is shown on the board?',
                options: ['Queen\'s Gambit', 'King\'s Gambit', 'London System'],
                answer: 'Queen\'s Gambit'
            },
            {
                name: 'Name the Opening',
                board: ['r.bqkbnr','pppp.ppp','..n..n..','.B.p....','..B.P...','.....N..','PPPP.PPP','R.Q.K..R'], // Italian Game
                question: 'Which opening is shown on the board?',
                options: ['Ruy Lopez', 'Italian Game', 'Scotch Game'],
                answer: 'Italian Game'
            },
            {
                name: 'Name the Opening',
                board: ['rnbqkb.r','pppp.p.p','..n..p..','........','..P.P...','...N....','PP.P.NPP','R.BQKB.R'], // King's Indian Defense
                question: 'Which opening is shown on the board?',
                options: ['Gr√ºnfeld Defense', 'King\'s Indian Defense', 'Nimzo-Indian Defense'],
                answer: 'King\'s Indian Defense'
            }
        ];
        let currentDrillIndex = 0;

        function loadPracticeDrill(index) {
            const drill = practiceDrills[index];
            const drillContainer = document.getElementById('practiceDrill');
            if (!drillContainer) return;

            const optionsHtml = drill.options.map(opt =>
                `<button class="w-full text-left p-3 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-indigo-100 dark:hover:bg-indigo-500" data-answer="${opt}">${opt}</button>`
            ).join('');

            drillContainer.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-yellow-400">${drill.name}</h3>
                <div class="flex justify-center mb-4">
                    <div id="practiceBoard" class="chessboard" style="width: 250px; height: 250px; font-size: 24px;"></div>
                </div>
                <p class="text-center mb-4 font-semibold text-gray-800 dark:text-gray-300">${drill.question}</p>
                <div class="space-y-2">${optionsHtml}</div>
                <p id="drillFeedback" class="mt-4 font-semibold h-5"></p>
                <button id="nextDrillBtn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-2 rounded-md hover:bg-indigo-500 transition hidden">Next Drill</button>
            `;

            // Render the practice board
            const practiceBoard = document.getElementById('practiceBoard');
            console.log('Rendering practice board. Target element:', practiceBoard ? practiceBoard.id : 'Not Found');
            renderBoard(drill.board, practiceBoard);

            drillContainer.querySelectorAll('[data-answer]').forEach(button => {
                button.addEventListener('click', () => {
                    const selectedAnswer = button.dataset.answer;
                    const feedbackEl = document.getElementById('drillFeedback');
                    if (selectedAnswer === drill.answer) {
                        feedbackEl.textContent = 'Correct!';
                        feedbackEl.className = 'mt-4 font-semibold text-green-600 dark:text-green-400';
                    } else {
                        feedbackEl.textContent = `Not quite. The correct answer is ${drill.answer}.`;
                        feedbackEl.className = 'mt-4 font-semibold text-red-600 dark:text-red-400';
                    }
                    document.getElementById('nextDrillBtn').classList.remove('hidden');
                });
            });

            document.getElementById('nextDrillBtn')?.addEventListener('click', () => {
                currentDrillIndex = (currentDrillIndex + 1) % practiceDrills.length;
                loadPracticeDrill(currentDrillIndex);
            });
        }

        // Initial load
        loadPracticeDrill(currentDrillIndex);
    </script>
    <!-- Keep your entire original index.html content here -->
...
<!-- At the very end, right before </body> -->
</body>
</html>

</body>
</html>
